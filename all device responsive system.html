<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Management System - Island Popup</title>
    <style>
        :root {
            --primary: #010203;
            --primary-light: #eff6ff;
            --primary-dark: #1fdc3bcf;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #14c5e4e0;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 260px;
        }

        body.dark-mode {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --primary: #3b82f6;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { margin: 0; background: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 20; /* Higher than kiosk */
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .brand { font-size: 1.4rem; font-weight: 700; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem; }
        
        .nav-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            white-space: nowrap;
        }
        
        .nav-item:hover { 
            background: rgba(37, 99, 235, 0.08); 
            transform: translateX(4px);
            color: var(--primary);
        }
        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
            transform: translateX(0);
        }

        /* Main Content */
        .main-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 2rem; 
            position: relative; 
            width: 100%; 
            max-width: 100%;
            background: var(--bg-body);
        }
        
        /* Components */
        .btn {
            padding: 0.75rem 1.5rem; /* Touch friendly */
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: 600; 
            transition: 0.2s;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); box-shadow: none; }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        input, select {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;
            background: var(--bg-body); color: var(--text-main); margin-bottom: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; }

        /* Status Badges */
        .badge { padding: 0.4rem 0.8rem; border-radius: 99px; font-size: 0.8rem; font-weight: 600; }
        .bg-green { background: #d1fae5; color: #065f46; }
        .bg-yellow { background: #fef3c7; color: #92400e; }
        .bg-red { background: #fee2e2; color: #991b1b; }

        /* Kiosk Mode (Full Screen) */
        #kiosk-view {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg-body); z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: flex-start; /* Changed to flex-start to handle centering internally */
            overflow-y: auto; /* Allow scrolling if content is tall */
        }
        #kiosk-view.active { display: flex; }
        
        /* THE ISLAND POPUP (Unified) */
        .kiosk-search-container { 
            width: 100%; 
            text-align: center; 
            padding-top: 2rem; 
            z-index: 105; 
            position: relative;
        }
        .kiosk-input { 
            font-size: 2.2rem; /* Bigger for mobile */
            padding: 1rem; 
            border: 2px solid var(--border); /* Blue border changed to neutral for island focus */
            border-radius: 1rem; 
            background: var(--bg-card);
            width: 90%; max-width: 600px;
            margin-bottom: 2rem;
            transition: all 0.3s;
        }
        .kiosk-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2); }

        /* The Island Card */
        #kioskResult {
            /* The Island Container */
            max-width: 600px;
            width: 90%;
            margin: 0 auto 2rem;
            background: var(--bg-card);
            border-radius: 24px; /* Round corners for Island */
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); /* Floating Island Shadow */
            padding: 2.5rem;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-height: 200px; /* Prevent layout shift */
            display: none; /* Hidden by default */
        }

        /* Success Mode (Welcome Message) */
        #kioskResult.success-mode {
            background: linear-gradient(135deg, var(--success) 0%, var(--success) 100%);
            color: white;
            border: none;
            transform: scale(1.05);
            box-shadow: 0 25px 50px rgba(16, 185, 129, 0.3);
        }

        #kioskResult.success-mode h2 {
            margin: 0;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        /* Content Styling inside Island */
        .kiosk-icon-large {
            font-size: 5rem;
            margin-bottom: 1rem;
            display: block;
            line-height: 1;
        }

        /* Old full screen overlay (Hidden as we use Island popup now) */
        #welcomeNotification { display: none; } 

        /* Animations */
        .bounce { animation: bounce 1.5s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .popIn { animation: popIn 0.3s ease-out; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 50; display: none;
            align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal { background: var(--bg-card); padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; text-align: center;}

        /* Landing Page Specifics */
        .landing-section {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%;
            text-align: center;
            padding: 2rem;
            background: var(--bg-body);
        }
        .landing-options { display: flex; flex-direction: column; gap: 1.5rem; margin-top: 2rem; width: 100%; max-width: 500px; }
        .landing-card {
            display: flex; flex-direction: row; align-items: center; justify-content: space-between; 
            padding: 2rem; border-radius: 1rem; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        .landing-card:hover { transform: scale(1.02); border-color: var(--border); }
        .landing-card:active { transform: scale(0.98); }
        .landing-member { background: var(--success); color: white; border-color: var(--success); }
        .landing-admin { background: var(--bg-card); border-color: var(--border); color: var(--text-main); }
        
        .landing-icon { font-size: 3rem; }
        .landing-title { font-size: 1.5rem; font-weight: bold; display: block; }
        .landing-desc { font-size: 1rem; color: var(--text-muted); display: block; }

        /* Utility */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mt-4 { margin-top: 1.5rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .text-danger { color: var(--danger); }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 1rem; align-items: flex-end; }
        .filter-group { flex: 1; }
        label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main); }
        
        /* Member Details Specifics */
        .details-result-card {
            max-width: 100%; /* Full width on mobile */
            margin: 20px 0; 
            border-top: 4px solid var(--primary);
        }
        /* Table Scroll for long list */
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Sidebar Bottom Controls */
        .sidebar-bottom {
            margin-top: auto;
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* =========================================
           RESPONSIVE DESIGN (MOBILE / TABLET)
           ========================================= */
        @media (max-width: 1024px) {
            /* Tablet Adjustments */
            .sidebar { width: 220px; }
            .brand { font-size: 1.2rem; }
        }

        @media (max-width: 768px) {
            /* Mobile Adjustments */
            
            /* 1. Main Layout Changes */
            .app-container { flex-direction: column; }
            
            /* 2. Sidebar becomes Bottom Navigation Bar */
            .sidebar {
                width: 100%;
                height: auto;
                min-height: 70px; /* Fixed height for touch bar */
                flex-direction: row;
                padding: 0.5rem 1rem;
                border-right: none;
                border-top: 1px solid var(--border);
                justify-content: space-between;
                align-items: center;
                background: var(--bg-card);
                z-index: 999; /* Float above everything */
            }

            .brand { display: none; } /* Hide brand name in bottom bar */
            
            /* Nav Menu styling for Bottom Bar */
            nav {
                display: flex;
                width: 100%;
                gap: 0.5rem;
                flex: 1;
                justify-content: center;
                overflow-x: auto; /* Allow horizontal scroll if many icons */
                padding-bottom: 0;
            }

            .nav-item {
                flex: 1;
                flex-direction: column; /* Stack Icon above Text */
                padding: 0.5rem 0.25rem;
                margin: 0;
                border-radius: 0.5rem;
                font-size: 0.8rem;
                white-space: nowrap;
                justify-content: center;
                min-width: 70px; /* Ensure tap targets are big enough */
                color: var(--text-main); /* Default color text for visibility */
            }
            
            .nav-item:hover {
                background: rgba(37, 99, 235, 0.05);
                transform: none;
                color: var(--primary);
            }

            /* Active State for Mobile */
            .nav-item.active {
                color: var(--primary);
                background: rgba(37, 99, 235, 0.05);
                border-bottom: 3px solid var(--primary);
            }

            /* Icon styling for Mobile */
            .nav-icon {
                font-size: 1.3rem; /* Large touch icons */
                margin-bottom: 0.25rem;
                display: block;
            }
            
            /* Hide Text if screen is very small, or keep it small */
            .nav-text {
                font-size: 0.75rem;
                display: block;
                margin-bottom: 0.25rem;
            }

            /* 3. Hide Desktop Lock Button */
            .sidebar-bottom { display: none; } 

            /* 4. Main Content takes full width */
            .main-content {
                width: 100%;
                padding: 1.5rem;
                padding-top: 80px; /* Space for bottom bar */
                margin-bottom: 70px; /* Space for bottom bar */
            }
            
            /* 5. Floating Lock Button for Mobile */
            .mobile-lock-fab {
                display: none; /* Hidden by default on CSS, but we will use JS to ensure logic */
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 40;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            /* Show FAB only on mobile logic via JS, handled by class */
            body.is-mobile .mobile-lock-fab { display: flex; }

            /* 6. Kiosk Mode adjustments */
            .kiosk-search-container { width: 100%; padding: 1rem; }
            .kiosk-input { font-size: 1.8rem; } /* Slightly smaller than desktop */
            
            /* 7. ISLAND POPUP on Mobile */
            #kioskResult {
                width: 95%; /* Wider on mobile */
                margin: 1.5rem auto;
                padding: 2rem 1.5rem;
            }
        }

        /* Hide scrollbars for cleaner mobile look */
        .sidebar::-webkit-scrollbar { display: none; }
        .sidebar { -ms-overflow-style: none; scrollbar-width: none; }

    </style>
</head>
<body>

<!-- SELECT MODE SECTION (Visible on Load) -->
<section id="landing-section" class="landing-section">
    <div style="margin-bottom: 1rem;">
        <span style="font-size: 3rem;"></span>
        <h1 style="margin: 0.5rem 0;">LDF OS</h1>
    </div>
    <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 1.5rem;">Select your mode</p>
    
    <div class="landing-options">
        <!-- Member Option -->
        <div class="landing-card landing-member" onclick="enterKioskMode()">
            <div class="landing-icon">üë§</div>
            <div class="landing-content">
                <span class="landing-title">Member</span>
                <span class="landing-desc">Mark Attendance</span>
            </div>
        </div>

        <!-- Admin Option -->
        <div class="landing-card landing-admin" onclick="showPasswordModal()">
            <div class="landing-icon">üîê</div>
            <div class="landing-content">
                <span class="landing-title">Admin</span>
                <span class="landing-desc">LDF OS</span>
            </div>
        </div>
    </div>
</section>

<!-- FLOATING MOBILE LOCK BUTTON -->
<div id="mobileLockFab" class="mobile-lock-fab" onclick="triggerLock()">üîí</div>

<!-- PASSWORD ONLY MODAL -->
<div id="passwordModal" class="modal-overlay">
    <div class="modal">
        <h2>üîí System Locked</h2>
        <p style="margin-bottom: 1rem;">Enter password to access Dashboard.</p>
        <input type="password" id="adminPassword" placeholder="Password" style="font-size: 1.1rem; padding: 0.8rem;">
        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="checkAuth()">Unlock</button>
        <button class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;" onclick="exitToLanding()">Back to Selection</button>
    </div>
</div>

<!-- Kiosk Mode (Full Screen) -->
<div id="kiosk-view">
    <!-- Full screen welcome overlay (Hidden, we use Island popup now) -->
    <div id="welcomeNotification" class="welcome-notification">
        <div>
            <h1>Welcome!</h1>
            <h2 id="welcomeMemberName">John Doe</h2>
            <div class="check-icon">‚úÖ</div>
            <p style="margin-top:20px;">Attendance Marked Successfully</p>
        </div>
    </div>

    <div class="kiosk-search-container">
        <h1 style="margin-top: 0;">Mark Attendance</h1>
        <input type="text" id="kioskInput" class="kiosk-input" placeholder="Enter Member ID" oninput="handleKioskSearch()">
        <button class="btn btn-outline mt-4" onclick="exitToLanding()">Exit</button>
        
        <!-- THE ISLAND POPUP -->
        <div id="kioskResult">
            <!-- Dynamic Content injected here -->
        </div>
    </div>
</div>

<div class="app-container hidden" id="adminInterface">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <span>LDF OS</span>
        </div>
        <nav>
            <div class="nav-item active" title="Dashboard" onclick="showSection('dashboard')">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </div>
            <div class="nav-item" title="All Members" onclick="showSection('members')">
                <span class="nav-icon">üë•</span>
                <span class="nav-text">Members</span>
            </div>
            <div class="nav-item" title="Member Details" onclick="showSection('member-details')">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Details</span>
            </div>
            <div class="nav-item" title="Unpaid" onclick="showSection('unpaid')">
                <span class="nav-icon">üí≥</span>
                <span class="nav-text">Unpaid</span>
            </div>
            <div class="nav-item" title="Monthly Attendance" onclick="showSection('attendance-log')">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-text">Log</span>
            </div>
            <div class="nav-item" title="Settings" onclick="showSection('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </div>
        </nav>
        
        <!-- Desktop Bottom Lock Button (Hidden on Mobile via CSS) -->
        <div class="sidebar-bottom">
             <button class="btn btn-danger" style="width: 100%; font-weight: bold;" onclick="triggerLock()">üîí LOCK</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Dashboard Section -->
        <section id="dashboard">
            <div class="flex-between mb-4">
                <h2>Smart Dashboard</h2>
                <button class="btn btn-success" onclick="showAddMemberModal()">+ Add Member</button>
            </div>
            <div class="grid-4">
                <div class="card">
                    <h3>Monthly Total</h3>
                    <h1 class="text-primary" id="statTotalMonthly">LKR 0.00</h1>
                    <button class="btn btn-sm btn-outline" onclick="resetFinancials('monthly')">Reset</button>
                </div>
                <div class="card">
                    <h3>Admission Fees</h3>
                    <h1 class="text-success" id="statTotalAdmission">LKR 0.00</h1>
                    <button class="btn btn-sm btn-outline" onclick="resetFinancials('admission')">Reset</button>
                </div>
                <div class="card">
                    <h3>Expiry Alerts</h3>
                    <h1 class="text-danger" id="statExpiryCount">0</h1>
                    <p class="text-sm">Members expired</p>
                </div>
                <div class="card">
                    <h3>Inactive (5+ Days)</h3>
                    <h1 class="text-warning" id="statInactiveCount">0</h1>
                    <p class="text-sm">Needs attention</p>
                </div>
                <div class="card" style="border-left: 5px solid var(--success);">
                    <h3>Today's Attendance</h3>
                    <h1 class="text-success" id="statTodayCount">0</h1>
                    <p class="text-sm">People present</p>
                </div>
            </div>
            <div class="grid-2 mt-4">
                <div class="card">
                    <div class="flex-between">
                        <h3>Inactivity Alerts (>5 Days)</h3>
                    </div>
                    <div id="notificationList" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted">No urgent alerts.</p>
                    </div>
                </div>
                <div class="card">
                    <h3>Reports</h3>
                    <div class="grid-2">
                        <button class="btn btn-outline" onclick="showReport('daily')">Daily Attendance</button>
                        <button class="btn btn-outline" onclick="showReport('monthly')">Monthly Summary</button>
                    </div>
                    <div id="reportResult" class="mt-4" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </section>

        <!-- Member Details Section (With Search) -->
        <section id="member-details" class="hidden">
            <div class="flex-between mb-4">
                <h2>Member Details</h2>
            </div>
            
            <div class="card">
                <label>Search Member (ID or Name)</label>
                <input type="text" id="detailsSearchInput" placeholder="Type to find member..." oninput="renderAllMemberDetails()">
            </div>

            <div id="detailsResultContainer" class="card details-result-card table-container">
                <table id="detailsTable" style="margin-top:0;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Age</th>
                            <th>Weight (kg)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Members Section -->
        <section id="members" class="hidden">
            <div class="flex-between mb-4">
                <h2>Member List</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="memberSearch" placeholder="Search ID or Name..." oninput="renderMembers()" style="margin-bottom: 0; width: 200px;">
                    <button class="btn btn-success" onclick="exportToCSV()">Export CSV</button>
                </div>
            </div>
            <div class="card table-container">
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Next Payment</th>
                            <th>Status</th>
                            <th>Unpaid Months</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody><!-- JS Populated --></tbody>
                </table>
            </div>
        </section>

        <!-- Unpaid Section -->
        <section id="unpaid" class="hidden">
            <h2>Unpaid Members</h2>
            <div class="card table-container">
                <table id="unpaidTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Last Payment</th>
                            <th>Due Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Monthly Attendance Log Section -->
        <section id="attendance-log" class="hidden">
            <div class="flex-between mb-4">
                <h2>Monthly Attendance Log</h2>
                <div style="text-align: right;">
                    <span class="text-muted">Total Visits This Month: </span>
                    <span id="monthTotalCount" class="font-bold text-primary" style="font-size: 1.5rem;">0</span>
                </div>
            </div>
            <div class="card table-container">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Select Month</label>
                        <input type="month" id="logMonthFilter" onchange="renderAttendanceLog()">
                    </div>
                    <div class="filter-group">
                        <label>Search ID (Optional)</label>
                        <input type="text" id="logIdFilter" placeholder="Enter Member ID..." oninput="renderAttendanceLog()">
                    </div>
                    <div class="filter-group" style="flex: 0;">
                        <label>&nbsp;</label>
                        <button class="btn btn-danger" onclick="deleteMonthLog()">Delete Month Log</button>
                    </div>
                </div>
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Settings / Backup Section -->
        <section id="settings" class="hidden">
            <h2>Settings & Backup</h2>
            <div class="grid-2">
                <div class="card">
                    <h3>Data Management</h3>
                    <p>Backup your data to a JSON file or restore from a file.</p>
                    <div class="flex-between mt-4">
                        <button class="btn btn-primary" onclick="downloadBackup()">Download Backup</button>
                        <input type="file" id="restoreFile" onchange="restoreBackup(this)">
                    </div>
                </div>
                <div class="card">
                    <h3>System</h3>
                    <p>Clear all local data (Factory Reset).</p>
                    <button class="btn btn-danger mt-4" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Add/Edit Member Modal -->
<div id="memberModal" class="modal-overlay">
    <div class="modal">
        <h3 id="modalTitle">Add New Member</h3>
        <form id="memberForm" onsubmit="handleMemberSubmit(event)">
            <input type="hidden" id="editId">
            
            <label>ID</label>
            <input type="text" id="inpId" required placeholder="e.g. M001">
            
            <label>Name</label>
            <input type="text" id="inpName" required placeholder="Full Name">
            
            <label>Phone Number</label>
            <div style="display:flex; gap:5px;">
                <input type="text" value="94" readonly style="width: 50px; text-align: center;">
                <input type="text" id="inpPhone" required placeholder="7xxxxxxx" pattern="[0-9]{9}" title="Enter 9 digits">
            </div>
            
            <label>Date of Birth</label>
            <input type="date" id="inpDob" required>
            
            <label>Address</label>
            <input type="text" id="inpAddress" placeholder="City, Street, House No...">
            
            <label>Weight (kg)</label>
            <input type="number" id="inpWeight" placeholder="e.g. 75.5" step="0.1">
            
            <label>Join Date / Payment Start Date</label>
            <input type="date" id="inpJoinDate" required title="This day will be used as fixed billing day every month.">
            
            <label>Monthly Membership Price (LKR)</label>
            <input type="number" id="inpPrice" required min="0">
            
            <label>Admission Fee (One Time - Optional)</label>
            <input type="number" id="inpAdmissionFee" value="0" min="0">
            
            <div class="flex-between mt-4">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Member</button>
            </div>
        </form>
    </div>
</div>

<!-- Payment History Modal -->
<div id="historyModal" class="modal-overlay">
    <div class="modal" style="max-width: 600px;">
        <h3>Payment History</h3>
        <table id="historyTable">
            <thead><tr><th>Date</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="flex-between mt-4">
            <button class="btn btn-danger" onclick="clearHistory()">Clear History</button>
            <button class="btn btn-outline" onclick="document.getElementById('historyModal').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
    /** 
     * STATE MANAGEMENT 
     */
    const APP_KEY = 'gym_sys_v15';
    let state = {
        members: [],
        attendance: [],
        financials: { monthly: 0, admission: 0 },
        settings: { darkMode: false }
    };

    let isAdminLoggedIn = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        applyTheme();
        document.getElementById('logMonthFilter').value = new Date().toISOString().slice(0, 7);
        
        // Responsive check for Mobile FAB
        if (window.innerWidth <= 768) {
            document.body.classList.add('is-mobile');
        }
        
        // START IN SELECT MODE SECTION (No auto-lock)
        document.getElementById('landing-section').style.display = 'flex';
    });

    function saveData() {
        localStorage.setItem(APP_KEY, JSON.stringify(state));
    }

    function loadData() {
        const stored = localStorage.getItem(APP_KEY);
        if (stored) {
            state = JSON.parse(stored);
        } else {
            seedData();
        }
    }

    function seedData() {
        const today = new Date();
        const dummyLogs = [];
        for(let i=0; i<5; i++) {
            dummyLogs.push({
                memberId: 'M001',
                date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - i).toISOString()
            });
        }

        state.members = [
            { id: 'M001', name: 'John Doe', phone: '712345678', dob: '1990-05-15', address: 'Colombo 05, Flower Road', weight: 75.5, joinDate: '2023-01-05', lastPayment: '2023-10-05', price: 1500, admissionPaid: true, history: [] },
            { id: 'M002', name: 'Jane Smith', phone: '798765432', dob: '1995-08-20', address: 'Kandy, Lake View', weight: 62.0, joinDate: '2023-06-01', lastPayment: '2023-09-01', price: 2000, admissionPaid: true, history: [] },
            { id: 'M003', name: 'Alice Brown', phone: '712345600', dob: '1988-03-10', address: 'Galle, Fort Area', weight: 55.2, joinDate: '2023-10-01', lastPayment: '2023-10-01', price: 1500, admissionPaid: true, history: [] }
        ];
        state.attendance = dummyLogs;
        saveData();
    }

    function toggleTheme() {
        state.settings.darkMode = !state.settings.darkMode;
        applyTheme();
        saveData();
    }

    function applyTheme() {
        if(state.settings.darkMode) document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    }

    /* AUTH & NAVIGATION LOGIC */
    
    // Triggered by "Lock" button in Sidebar (Desktop) or Mobile FAB
    function triggerLock() {
        // Hide everything
        document.getElementById('landing-section').style.display = 'none';
        document.getElementById('adminInterface').classList.add('hidden'); 
        
        // Show Password Modal only
        document.getElementById('passwordModal').style.display = 'flex';
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
    }

    // Exits to Selection View
    function exitToLanding() {
        // Hide modals/kiosk
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('kiosk-view').classList.remove('active');
        document.getElementById('adminInterface').classList.add('hidden'); // Ensure admin is hidden
        
        // Reset Kiosk State
        resetKioskUI();
        
        // Show Landing Section
        document.getElementById('landing-section').style.display = 'flex';
    }

    // Triggered by "Admin" card in Selection View
    function showPasswordModal() {
        document.getElementById('landing-section').style.display = 'none';
        document.getElementById('passwordModal').style.display = 'flex';
        document.getElementById('adminPassword').focus();
    }

    function checkAuth() {
        const pass = document.getElementById('adminPassword').value;
        if(pass === "LDF0701#") {
            isAdminLoggedIn = true;
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('adminInterface').classList.remove('hidden');
            renderDashboard();
        } else {
            alert("Incorrect Password");
        }
    }

    function showSection(id) {
        if(!isAdminLoggedIn) return;
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navIndex = ['dashboard','members','member-details','unpaid','attendance-log','settings'].indexOf(id);
        if(navIndex >= 0) document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

        if(id === 'members') renderMembers();
        if(id === 'member-details') renderAllMemberDetails();
        if(id === 'unpaid') renderUnpaid();
        if(id === 'attendance-log') renderAttendanceLog();
        if(id === 'dashboard') renderDashboard();
    }

    /* KIOSK MODE LOGIC */
    function enterKioskMode() {
        document.getElementById('landing-section').style.display = 'none';
        document.getElementById('adminInterface').classList.add('hidden'); 
        document.getElementById('kiosk-view').classList.add('active');
        document.getElementById('kioskInput').focus();
    }

    function resetKioskUI() {
        // Hide the island popup
        const resultBox = document.getElementById('kioskResult');
        resultBox.classList.remove('success-mode');
        resultBox.classList.remove('popIn');
        resultBox.style.display = 'none';
        document.getElementById('kioskInput').value = '';
        document.getElementById('kioskInput').disabled = false;
    }

    function handleKioskSearch() {
        const val = document.getElementById('kioskInput').value.trim();
        const resultBox = document.getElementById('kioskResult');
        
        // Remove success state if user types again
        resultBox.classList.remove('success-mode');
        resultBox.classList.remove('popIn');
        resultBox.style.display = 'none';

        if (!val) return;

        const member = state.members.find(m => m.id === val || m.name.toLowerCase() === val.toLowerCase());
        
        if (member) {
            const billingInfo = getMemberBillingInfo(member);
            const currentMonth = new Date().toISOString().slice(0, 7);
            const daysAttended = state.attendance.filter(a => a.memberId === member.id && a.date.startsWith(currentMonth)).length;
            const myAttendances = state.attendance.filter(a => a.memberId === member.id).sort((a,b) => new Date(b.date) - new Date(a.date));
            let lastDate = myAttendances.length > 0 ? new Date(myAttendances[0].date) : new Date(member.joinDate);
            let daysDiff = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
            
            // Absence Message
            let absenceMsg = (daysDiff >= 5) ? `<div style="color:var(--danger); margin-top:10px; font-weight:bold; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">‚ö†Ô∏è Absent for ${daysDiff} days.</div>` : "";

            // Inject Member Info HTML
            resultBox.innerHTML = `
                <h2 style="margin:0 0 10px 0; color: var(--primary);">${member.name}</h2>
                <p style="margin:0; font-size:1.2rem; color:var(--text-muted);"><strong>ID:</strong> ${member.id}</p>
                <p style="margin:10px 0;"><strong>Next Payment:</strong> ${billingInfo.nextDate.toDateString()}</p>
                <p style="margin:0;">Visits this month: ${daysAttended}</p>
                ${absenceMsg}
                <br><br>
                <button class="btn btn-primary" style="width:100%; font-size:1.2rem; padding: 1rem; justify-content: center;" onclick="markAttendance('${member.id}')">‚úÖ MARK PRESENT</button>
            `;
            
            // Show Island with popIn animation
            resultBox.style.display = 'block';
            resultBox.classList.add('popIn');
        }
    }

    function markAttendance(id) {
        const member = state.members.find(m => m.id === id);
        const today = new Date().toISOString();
        const datePart = today.split('T')[0];
        const alreadyMarked = state.attendance.find(a => a.memberId === id && a.date.startsWith(datePart));
        
        if (alreadyMarked) {
            alert("Already marked present today!");
            return;
        }
        
        // Save Data
        state.attendance.push({ memberId: id, date: today });
        saveData();

        // Update UI to Welcome State (Morph Island)
        const resultBox = document.getElementById('kioskResult');
        resultBox.classList.remove('popIn'); // Remove entry animation
        resultBox.classList.add('success-mode');

        resultBox.innerHTML = `
            <div class="kiosk-icon-large bounce">‚úÖ</div>
            <h2>Welcome!</h2>
            <h3 style="margin: 0.5rem 0; font-size: 1.5rem;">${member.name}</h3>
            <p style="margin-top: 1rem; font-size: 1.1rem;">Attendance Marked Successfully</p>
        `;

        // Automatically reset after 2 seconds
        setTimeout(() => {
            resetKioskUI();
            document.getElementById('kioskInput').focus();
        }, 2500);
    }

    /* MEMBER DETAILS SECTION LOGIC (SEARCH ENABLED) */
    function renderAllMemberDetails() {
        const tbody = document.querySelector('#detailsTable tbody');
        tbody.innerHTML = '';
        
        // Get search value
        const filter = document.getElementById('detailsSearchInput').value.toLowerCase().trim();
        
        // Filter members array based on ID or Name
        const filteredMembers = state.members.filter(m => 
            m.name.toLowerCase().includes(filter) || 
            m.id.toLowerCase().includes(filter)
        );

        if (filteredMembers.length === 0 && filter !== '') {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No members found</td></tr>';
            return;
        }

        // Loop and render
        filteredMembers.forEach(m => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${m.id}</td>
                <td>${m.name}</td>
                <td>94${m.phone}</td>
                <td>${m.address || '-'}</td>
                <td>${getAge(m.dob)}</td>
                <td><strong>${m.weight || '-'}</strong></td>
            `;
            tbody.appendChild(tr);
        });
    }

    /* BILLING LOGIC */
    function getMemberBillingInfo(member) {
        const today = new Date();
        today.setHours(0,0,0,0);
        const joinDate = new Date(member.joinDate);
        const billingDay = joinDate.getDate();
        let currentCycleDue = new Date(today.getFullYear(), today.getMonth(), billingDay);
        let nextPaymentDate = (currentCycleDue > today) ? currentCycleDue : new Date(today.getFullYear(), today.getMonth() + 1, billingDay);
        const lastPay = new Date(member.lastPayment);
        lastPay.setHours(0,0,0,0);
        const isOverdue = (today >= currentCycleDue) && (lastPay < currentCycleDue);
        return {
            nextDate: nextPaymentDate,
            status: isOverdue ? 'Overdue' : 'Paid',
            class: isOverdue ? 'bg-red' : 'bg-green'
        };
    }

    function showAddMemberModal() {
        document.getElementById('memberForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('modalTitle').innerText = 'Add New Member';
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('inpJoinDate').value = today;
        document.getElementById('memberModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('memberModal').style.display = 'none';
        document.getElementById('historyModal').style.display = 'none';
    }

    function handleMemberSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('inpId').value.trim();
        const name = document.getElementById('inpName').value.trim();
        const phone = document.getElementById('inpPhone').value.trim();
        const dob = document.getElementById('inpDob').value;
        const address = document.getElementById('inpAddress').value.trim();
        const weight = parseFloat(document.getElementById('inpWeight').value) || 0;
        const joinDate = document.getElementById('inpJoinDate').value;
        const price = parseFloat(document.getElementById('inpPrice').value);
        const admissionFee = parseFloat(document.getElementById('inpAdmissionFee').value) || 0;

        const existingIndex = state.members.findIndex(m => m.id === id);
        
        if (existingIndex > -1) {
            if(confirm("Member ID already exists. Update details?")) {
                state.members[existingIndex] = { ...state.members[existingIndex], name, phone, dob, address, weight, joinDate, price };
                alert("Member Updated Successfully");
            } else {
                return;
            }
        } else {
            const memberData = {
                id, name, phone, dob, address, weight, joinDate, price,
                lastPayment: joinDate,
                admissionPaid: admissionFee > 0,
                history: []
            };
            if (admissionFee > 0) {
                state.financials.admission += admissionFee;
                memberData.history.push({ date: joinDate, type: 'Admission', amount: admissionFee });
            }
            state.financials.monthly += price;
            memberData.history.push({ date: joinDate, type: 'Monthly', amount: price });
            state.members.push(memberData);
            alert("New Member Added Successfully");
        }
        
        saveData();
        closeModal();
        renderMembers();
        renderDashboard();
    }

    function deleteMember(id) {
        if(confirm("Are you sure you want to delete this member?")) {
            state.members = state.members.filter(m => m.id !== id);
            state.attendance = state.attendance.filter(a => a.memberId !== id);
            saveData();
            renderMembers();
        }
    }

    function getAge(dob) {
        const diff = Date.now() - new Date(dob).getTime();
        return Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
    }

    function renderMembers() {
        if(!isAdminLoggedIn) return;
        const tbody = document.querySelector('#membersTable tbody');
        tbody.innerHTML = '';
        const filter = document.getElementById('memberSearch').value.toLowerCase();

        state.members.forEach(m => {
            if (m.name.toLowerCase().includes(filter) || m.id.toLowerCase().includes(filter)) {
                const billingInfo = getMemberBillingInfo(m);
                const unpaidMonths = Math.max(0, (new Date().getFullYear() - new Date(m.lastPayment).getFullYear()) * 12 + (new Date().getMonth() - new Date(m.lastPayment).getMonth()));
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.id}</td>
                    <td>${m.name}</td>
                    <td><strong>${billingInfo.nextDate.toDateString()}</strong></td>
                    <td><span class="badge ${billingInfo.class}">${billingInfo.status}</span></td>
                    <td>${unpaidMonths}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="activatePayment('${m.id}')">Pay</button>
                        <button class="btn btn-sm btn-outline" onclick="viewHistory('${m.id}')">History</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMember('${m.id}')">Del</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function renderUnpaid() {
        if(!isAdminLoggedIn) return;
        const tbody = document.querySelector('#unpaidTable tbody');
        tbody.innerHTML = '';
        state.members.forEach(m => {
            const billingInfo = getMemberBillingInfo(m);
            if (billingInfo.status === 'Overdue') {
                const unpaidMonths = Math.max(0, (new Date().getFullYear() - new Date(m.lastPayment).getFullYear()) * 12 + (new Date().getMonth() - new Date(m.lastPayment).getMonth()));
                const due = unpaidMonths * m.price;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.id}</td>
                    <td>${m.name}</td>
                    <td>${billingInfo.nextDate.toDateString()}</td>
                    <td>LKR ${due.toFixed(2)}</td>
                    <td>
                        <a href="https://wa.me/94${m.phone}?text=Hello ${m.name}, your membership payment is overdue. Please pay LKR ${due}." target="_blank" class="btn btn-sm btn-success">WhatsApp</a>
                        <button class="btn btn-sm btn-primary" onclick="activatePayment('${m.id}')">Activate</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    /* PAYMENT & FINANCIALS */
    function activatePayment(id) {
        const amount = prompt("Enter payment amount (LKR):", "1500");
        if (amount) {
            const member = state.members.find(m => m.id === id);
            const today = new Date().toISOString().split('T')[0];
            member.lastPayment = today;
            state.financials.monthly += parseFloat(amount);
            member.history.push({ date: today, type: 'Monthly', amount: parseFloat(amount) });
            saveData();
            alert("Payment Recorded & Membership Activated");
            renderMembers();
            renderUnpaid();
            renderDashboard();
        }
    }

    function resetFinancials(type) {
        if(confirm(`Reset ${type} total counter?`)) {
            if(type === 'monthly') state.financials.monthly = 0;
            if(type === 'admission') state.financials.admission = 0;
            saveData();
            renderDashboard();
        }
    }

    function viewHistory(id) {
        const member = state.members.find(m => m.id === id);
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        if(member.history) {
            member.history.forEach(h => {
                tbody.innerHTML += `<tr><td>${h.date}</td><td>${h.type}</td><td>LKR ${h.amount}</td></tr>`;
            });
        }
        document.getElementById('historyModal').style.display = 'flex';
    }
    
    function clearHistory() {
        alert("This feature would clear current member's history.");
        document.querySelector('#historyTable tbody').innerHTML = '';
    }

    /* MONTHLY ATTENDANCE */
    function renderAttendanceLog() {
        if(!isAdminLoggedIn) return;
        const tbody = document.querySelector('#attendanceTable tbody');
        tbody.innerHTML = '';
        const monthVal = document.getElementById('logMonthFilter').value;
        const idFilter = document.getElementById('logIdFilter').value.toLowerCase().trim();
        let filtered = state.attendance.filter(a => a.date.startsWith(monthVal));
        if (idFilter) filtered = filtered.filter(a => a.memberId.toLowerCase().includes(idFilter));
        document.getElementById('monthTotalCount').innerText = filtered.length;
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        filtered.forEach(a => {
            const m = state.members.find(x => x.id === a.memberId);
            if (m) {
                const dateObj = new Date(a.date);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dateObj.toLocaleDateString()}</td>
                    <td>${m.id}</td>
                    <td>${m.name}</td>
                    <td>${dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteAttendance('${a.date}')">Del</button></td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function deleteAttendance(fullDate) {
        if(confirm("Delete this attendance record?")) {
            state.attendance = state.attendance.filter(a => a.date !== fullDate);
            saveData();
            renderAttendanceLog();
        }
    }

    function deleteMonthLog() {
        const monthVal = document.getElementById('logMonthFilter').value;
        if (!monthVal) return;
        const count = state.attendance.filter(a => a.date.startsWith(monthVal)).length;
        if (confirm(`Are you sure you want to delete ALL ${count} attendance records for ${monthVal}?`)) {
            state.attendance = state.attendance.filter(a => !a.date.startsWith(monthVal));
            saveData();
            renderAttendanceLog();
            alert("Log deleted.");
        }
    }

    /* DASHBOARD */
    function renderDashboard() {
        if(!isAdminLoggedIn) return;
        document.getElementById('statTotalMonthly').innerText = `LKR ${state.financials.monthly.toFixed(2)}`;
        document.getElementById('statTotalAdmission').innerText = `LKR ${state.financials.admission.toFixed(2)}`;
        const todayStr = new Date().toISOString().split('T')[0];
        const todayCount = state.attendance.filter(a => a.date.startsWith(todayStr)).length;
        document.getElementById('statTodayCount').innerText = todayCount;
        const today = new Date();
        let expiryCount = 0;
        let inactiveCount = 0;
        let notifHTML = '';
        state.members.forEach(m => {
            const billingInfo = getMemberBillingInfo(m);
            if (billingInfo.status === 'Overdue') expiryCount++;
            const myAttendances = state.attendance.filter(a => a.memberId === m.id).sort((a,b) => new Date(b.date) - new Date(a.date));
            let lastDate = myAttendances.length > 0 ? new Date(myAttendances[0].date) : new Date(m.joinDate);
            let daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
            if (daysDiff >= 5) {
                inactiveCount++;
                const msg = `Hello ${m.name}, we noticed you haven't been to gym for past few days. Is everything okay?`;
                const encodedMsg = encodeURIComponent(msg);
                notifHTML += `
                <div style="border-bottom:1px solid #eee; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div><strong>${m.name}</strong> (ID: ${m.id})<br><span class="text-danger text-sm">Absent for ${daysDiff} days</span></div>
                    <div style="text-align:right">
                        <a href="https://wa.me/94${m.phone}?text=${encodedMsg}" target="_blank" class="btn btn-sm btn-success">Send WA Msg</a>
                    </div>
                </div>`;
            }
        });
        document.getElementById('statExpiryCount').innerText = expiryCount;
        document.getElementById('statInactiveCount').innerText = inactiveCount;
        document.getElementById('notificationList').innerHTML = notifHTML || '<p class="text-muted">No urgent alerts.</p>';
    }

    function showReport(type) {
        if(!isAdminLoggedIn) return;
        const container = document.getElementById('reportResult');
        container.innerHTML = '';
        if (type === 'daily') {
            const today = new Date().toISOString().split('T')[0];
            const records = state.attendance.filter(a => a.date.startsWith(today));
            let html = '<h4>Present Today:</h4><ul>';
            records.forEach(r => {
                const m = state.members.find(x => x.id === r.memberId);
                if(m) html += `<li>${m.name} (${m.id})</li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        } else if (type === 'monthly') {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const records = state.attendance.filter(a => a.date.startsWith(currentMonth));
            const counts = {};
            records.forEach(r => { counts[r.memberId] = (counts[r.memberId] || 0) + 1; });
            let html = '<h4>Visits This Month:</h4><ul>';
            for (const [id, count] of Object.entries(counts)) {
                const m = state.members.find(x => x.id === id);
                if(m) html += `<li>${m.name}: ${count} days</li>`;
            }
            html += '</ul>';
            container.innerHTML = html;
        }
    }

    /* UTILS */
    function downloadBackup() {
        if(!isAdminLoggedIn) return;
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "gym_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreBackup(input) {
        if(!isAdminLoggedIn) return;
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                state = JSON.parse(e.target.result);
                saveData();
                alert("Backup restored successfully!");
                location.reload();
            } catch(err) {
                alert("Invalid backup file.");
            }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if(!isAdminLoggedIn) return;
        if(confirm("DANGER: This will wipe all data. Are you sure?")) {
            localStorage.removeItem(APP_KEY);
            location.reload();
        }
    }

    function exportToCSV() {
        if(!isAdminLoggedIn) return;
        let csvContent = "data:text/csv;charset=utf-8,ID,Name,Phone,Address,Weight,DOB,Join Date,Last Payment,Status,Unpaid Months\n";
        state.members.forEach(m => {
            const billingInfo = getMemberBillingInfo(m);
            const unpaid = Math.max(0, (new Date().getFullYear() - new Date(m.lastPayment).getFullYear()) * 12 + (new Date().getMonth() - new Date(m.lastPayment).getMonth()));
            csvContent += `${m.id},${m.name},94${m.phone},"${m.address || ''}",${m.weight || 0},${m.dob},${m.joinDate},${m.lastPayment},${billingInfo.status},${unpaid}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "gym_members.csv");
        document.body.appendChild(link);
        link.click();
        link.remove();
    }
</script>
</body>
</html>