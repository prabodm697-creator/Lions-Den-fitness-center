<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Smart Alerts</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --wa-green: #25D366;
            --wa-gray: #cbd5e1;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-box {
            background: var(--card); padding: 2.5rem; border-radius: 12px;
            width: 340px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .login-box h2 { margin-bottom: 1rem; color: var(--primary); }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 6px; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .error { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }

        /* --- DASHBOARD --- */
        #dashboard { display: none; height: 100vh; flex-direction: column; }
        
        header {
            background: var(--card); padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }

        /* Notification Bell */
        .notif-wrap { position: relative; cursor: pointer; margin-right: 20px; }
        .bell-icon { font-size: 1.4rem; color: #64748b; }
        .bell-badge {
            position: absolute; top: -5px; right: -5px; background: var(--danger);
            color: white; font-size: 0.75rem; width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; display: none;
        }
        .notif-dropdown {
            position: absolute; top: 50px; right: 0; width: 300px; background: white;
            border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 8px; display: none; z-index: 100; max-height: 400px; overflow-y: auto;
        }
        .notif-item { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .notif-item.due-tomorrow { border-left: 3px solid var(--warning); background: #fffbeb; }
        .notif-item.overdue { border-left: 3px solid var(--danger); background: #fef2f2; }

        main { flex: 1; padding: 2rem; overflow-y: auto; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        .grid { display: grid; grid-template-columns: 320px 1fr; gap: 2rem; }
        .card { background: var(--card); padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; }
        
        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: #64748b; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .btn-add { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px;}

        /* Backup Buttons */
        .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-backup { padding: 10px; font-size: 0.85rem; border: none; border-radius: 6px; cursor: pointer; color: white; }
        .btn-download { background: #0f172a; }
        .btn-upload { background: #64748b; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        th { background: #f8fafc; color: #64748b; font-size: 0.8rem; text-transform: uppercase; }
        
        /* Action Buttons */
        .btn-pay { padding: 6px 12px; background: #0f172a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-delete { padding: 6px 12px; background: transparent; color: var(--danger); border: 1px solid var(--danger); border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        /* WhatsApp Button Logic */
        .btn-wa {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px;
            border: none; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 600;
            transition: 0.2s;
        }
        /* GREEN: Day before, Today, Overdue (Alert is Active) */
        .btn-wa.green { background: var(--wa-green); color: white; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.2); }
        .btn-wa.green:hover { background: #1ebc57; }
        /* GRAY: Future (No Alert) */
        .btn-wa.gray { background: var(--wa-gray); color: #475569; cursor: default; }
        
        /* Status Indicator */
        .status { font-size: 0.75rem; font-weight: bold; padding: 2px 8px; border-radius: 10px; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-due { background: #fee2e2; color: #991b1b; }

        /* Toast */
        #toast {
            position: fixed; bottom: 30px; right: 30px; background: #0f172a; color: white;
            padding: 15px 25px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            transform: translateY(100px); transition: transform 0.3s; z-index: 2000;
        }
        #toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- 1. LOCK SCREEN -->
    <div id="lock-screen">
        <div class="login-box">
            <h2><i class="fas fa-user-shield"></i> Admin Only</h2>
            <input type="password" id="adminPass" placeholder="Enter Password (Default: admin)">
            <button onclick="unlockSystem()">Unlock</button>
            <div class="error" id="errorMsg">Incorrect Password</div>
        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div id="dashboard" style="display:none;">
        <header>
            <div class="brand"><i class="fas fa-dumbbell" style="color: var(--primary);"></i> LDF System</div>
            <div style="display:flex; align-items:center;">
                <!-- ALERT BELL -->
                <div class="notif-wrap" onclick="toggleDropdown()">
                    <i class="fas fa-bell bell-icon"></i>
                    <div class="bell-badge" id="bellBadge">0</div>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">Payment Alerts</div>
                        <div id="notifList"></div>
                    </div>
                </div>
                <button onclick="location.reload()" style="border:none; background:none; cursor:pointer; color:#64748b;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <main>
            <div class="grid">
                <!-- Left Column: Form & Backup -->
                <div>
                    <!-- Add Member -->
                    <div class="card">
                        <h3>Add New Member</h3>
                        <form onsubmit="addMember(event)">
                            <div class="form-group">
                                <label>Member Name</label>
                                <input type="text" id="mName" required placeholder="e.g. John Doe">
                            </div>
                            <div class="form-group">
                                <label>Phone (Auto 94)</label>
                                <input type="tel" id="mPhone" required placeholder="e.g. 712345678" oninput="updatePhonePreview()">
                                <small style="color:#64748b; font-size:0.75rem;">Saved as: <strong id="phonePreview">94...</strong></small>
                            </div>
                            <div class="form-group">
                                <label>Monthly Fee</label>
                                <input type="number" id="mFee" required placeholder="e.g. 2000">
                            </div>
                            <div class="form-group">
                                <label>Member ID (Auto)</label>
                                <input type="text" id="mId" readonly style="background:#f1f5f9;">
                            </div>
                            <div class="form-group">
                                <label>Next Payment Day</label>
                                <input type="date" id="mDate" required>
                            </div>
                            <button type="submit" class="btn-add">Register Member</button>
                        </form>
                    </div>

                    <!-- Backup System -->
                    <div class="card">
                        <h3><i class="fas fa-database"></i> Data Backup</h3>
                        <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">Download data to save, or upload to restore.</p>
                        <div class="backup-grid">
                            <button class="btn-backup btn-download" onclick="downloadBackup()">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn-backup btn-upload" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="uploadBackup(this)">
                        </div>
                    </div>
                </div>

                <!-- Right Column: List -->
                <div class="card">
                    <h3>Members List</h3>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Fee</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>WhatsApp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- JS populates this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast">Action Saved</div>

    <script>






        // --- CONFIGURATION ---
        const PASS = "LDF"; 
        const DB_KEY = "gym_system_alerts_v5";
        let members = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let startId = 1001;











        // --- AUTH ---
        function unlockSystem() {
            const input = document.getElementById('adminPass').value;
            if (input === PASS) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                initApp();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // --- INITIALIZATION ---
        function initApp() {
            generateID();
            document.getElementById('mDate').valueAsDate = new Date();
            renderTable();
            checkAlerts(); // Run Alert Logic
        }

        function generateID() {
            const next = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : startId;
            document.getElementById('mId').value = next;
        }

        function updatePhonePreview() {
            const val = document.getElementById('mPhone').value;
            document.getElementById('phonePreview').innerText = "94" + val;
        }

        // --- ADD MEMBER ---
        function addMember(e) {
            e.preventDefault();
            const name = document.getElementById('mName').value;
            let phone = document.getElementById('mPhone').value;
            const fee = document.getElementById('mFee').value;
            const id = parseInt(document.getElementById('mId').value);
            const date = document.getElementById('mDate').value;

            // Auto prefix 94
            phone = phone.replace(/\D/g, '');
            if (!phone.startsWith('94')) {
                phone = '94' + phone;
            }

            members.push({ id, name, phone, fee, nextDue: date });
            saveData();

            e.target.reset();
            generateID();
            document.getElementById('mDate').valueAsDate = new Date();
            document.getElementById('phonePreview').innerText = "94...";
            renderTable();
            checkAlerts();
            showToast("Member Added & Saved");
        }

        // --- ALERT LOGIC (CORE REQUIREMENT) ---
        function checkAlerts() {
            const today = new Date();
            today.setHours(0,0,0,0);

            let alertCount = 0;
            const list = document.getElementById('notifList');
            list.innerHTML = '';

            members.forEach(m => {
                const due = new Date(m.nextDue);
                due.setHours(0,0,0,0);
                
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                // LOGIC: 
                // Alert comes ONE DAY BEFORE (diffDays === 1)
                // Alert continues AFTER DUE (diffDays <= 0)
                // Alert GOES OFF when diffDays > 1 (Future)
                
                if (diffDays <= 1) {
                    alertCount++;
                    let typeClass = 'due-tomorrow';
                    let msg = `Due Tomorrow`;
                    
                    if (diffDays < 0) {
                        typeClass = 'overdue';
                        msg = `Overdue by ${Math.abs(diffDays)} days`;
                    } else if (diffDays === 0) {
                        typeClass = 'overdue';
                        msg = `Due Today`;
                    }

                    list.innerHTML += `
                        <div class="notif-item ${typeClass}">
                            <strong>#${m.id} ${m.name}</strong><br>
                            <small>${msg}. Fee: $${m.fee}</small>
                        </div>
                    `;
                }
            });

            const badge = document.getElementById('bellBadge');
            if (alertCount > 0) {
                badge.style.display = 'flex';
                badge.innerText = alertCount;
            } else {
                badge.style.display = 'none';
                list.innerHTML = '<div style="padding:10px; text-align:center; color:#94a3b8;">No payment alerts.</div>';
            }
        }

        function toggleDropdown() {
            const d = document.getElementById('notifDropdown');
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        }

        // --- RENDER LOGIC (COLOR BUTTONS) ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0);

            members.sort((a,b) => new Date(a.nextDue) - new Date(b.nextDue));

            members.forEach(m => {
                const due = new Date(m.nextDue);
                due.setHours(0,0,0,0);
                
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                // Logic: Green if diffDays <= 1. Gray if diffDays > 1.
                // This matches the Alert Logic exactly.
                const isGreen = diffDays <= 1;
                
                let statusHTML = `<span class="status status-active">Active</span>`;
                if (diffDays < 0) statusHTML = `<span class="status status-due">Overdue</span>`;
                else if (diffDays === 0) statusHTML = `<span class="status status-due">Due Today</span>`;

                // WhatsApp Logic
                const msg = `Hello ${m.name}, Payment Reminder. ID: ${m.id}. Due: ${m.nextDue}. Fee: ${m.fee}.`;
                const waLink = `https://wa.me/${m.phone}?text=${encodeURIComponent(msg)}`;

                const btnColorClass = isGreen ? 'green' : 'gray';
                const btnText = isGreen ? 'Send Reminder' : 'Paid / Active';
                const btnIcon = '<i class="fab fa-whatsapp"></i>';
                const href = isGreen ? `href="${waLink}" target="_blank"` : `href="#" onclick="return false;"`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${m.id}</strong></td>
                    <td>${m.name}</td>
                    <td>${m.phone}</td>
                    <td>${m.fee}</td>
                    <td>${formatDate(m.nextDue)}</td>
                    <td>${statusHTML}</td>
                    <td>
                        <a ${href} class="btn-wa ${btnColorClass}">
                            ${btnIcon} ${btnText}
                        </a>
                    </td>
                    <td>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-pay" onclick="activateMember(${m.id})"><i class="fas fa-check"></i></button>
                            <button class="btn-delete" onclick="deleteMember(${m.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ACTIVATE MEMBER (PAY) ---
        function activateMember(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                const today = new Date().toISOString().split('T')[0];
                member.nextDue = addMonths(today, 1);
                saveData();
                renderTable();
                checkAlerts(); // Re-run checks to turn off Alert
                showToast(`Member #${id} Activated! Alert Cleared.`);
            }
        }

        // --- DELETE MEMBER ---
        function deleteMember(id) {
            // "Listening twice" confirmation
            const confirmFirst = confirm(`Are you sure you want to delete Member #${id}?`);
            if (confirmFirst) {
                const confirmSecond = confirm("This action cannot be undone. Confirm deletion again?");
                if (confirmSecond) {
                    members = members.filter(m => m.id !== id);
                    saveData();
                    renderTable();
                    checkAlerts();
                    showToast("Member Deleted");
                }
            }
        }

        // --- BACKUP SYSTEM ---
        function downloadBackup() {
            const dataStr = JSON.stringify(members, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "gym_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("Backup Downloaded");
        }

        function uploadBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (Array.isArray(loadedData)) {
                        const confirmRestore = confirm("This will replace current data. Continue?");
                        if(confirmRestore) {
                            members = loadedData;
                            saveData();
                            renderTable();
                            checkAlerts();
                            showToast("Data Restored Successfully");
                        }
                    } else {
                        alert("Invalid backup file.");
                    }
                } catch (err) {
                    alert("Error reading file.");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- HELPERS ---
        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(members)); }

        function addMonths(dateStr, months) {
            const d = new Date(dateStr);
            d.setMonth(d.getMonth() + months);
            return d.toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Close dropdown on outside click
        window.onclick = function(e) {
            if (!e.target.closest('.notif-wrap')) {
                document.getElementById('notifDropdown').style.display = 'none';
            }
        }
    </script>
</body>
</html>